---
title: A Case for ALL CAPS
author: Alicia Brown
date: '2020-12-23'
slug: a-case-for-allcaps
categories:
  - datatable
  - case
  - sort
  - r
tags:
  - datatable
  - setorder
  - tidyverse
  - arrange
---

Recently I resumed PPE allocation duties for a couple of weeks and took the opportunity to automate a checklist of the orders sorted by region to help with their packaging for delivery. As a data person, I couldn't help but also sort the names of agencies after region. The resulting data surprised me when I noticed that the secondary sort by agency names placed agencies with names in ALL CAPS  before other agencies with Title Case names. 

This led me to wonder -

1. Do different libraries sort character values differently? I'm typically on #TeamDataverse because [dplyr](https://dplyr.tidyverse.org/) makes it a snap to do things and just make sense to human brains. 
2. Is there an advantage to use ALL CAPS if there's a chance to be sorted first in a mixed case data environment? As someone whose first and last names are at the beginning of the alphabet, I have wondered whether that's been an advantage to me or if I've been lucky on the occasions where I was selected in contests and seat upgrades. 

## A review of the data

This data was downloaded from the Washington State Department of Social and Health Services [website](https://fortress.wa.gov/dshs/adsaapps/Lookup/NHAdvLookup.aspx) filtered for King County. When the search results are returned by the website, it is sorted by Agency name as one would expect, where the case does not matter, though it would be nice if the names could have been consistently formatted and makes me wonder about how the data gets to the state. Does one data entry person enter names in ALL CAPS or do the providers enter their names in ALL CAPS? All other data fields across agencies appears "properly" Title Cased, even Admin names.

```{r just_the_data, echo=T, warning=F, message=F}
library(DT)
library(here)
library(knitr)
library(tidyverse)

data <- read_csv(here("static", "data", "NFListing.csv")) %>%
  select(nf_name,nf_loc_city) %>%
  rename(name = nf_name, city = nf_loc_city) 
  
data %>%
  select(name, city) %>%
  datatable(extensions = c('Buttons'), 
          options = list(dom = 'Blfrtip',
          buttons = c('excel','copy'),
          pageLength = 20))
```

## #TeamTidyverse > Take 1

In the Tidyverse, we can [arrange](https://dplyr.tidyverse.org/reference/arrange.html) data by multiple fields and see if the case matters. Our first opportunity to check the data occurs for Federal Way since there are both Title Case and ALL CAPS city and agency names.

```{r tidyverse_}
data %>%
  arrange(city, name) %>%
  select(city, name) %>%
  kable()
```

***Observation:***: Title Case city names precede ALL CAPS city names per AVALON CARE CENTER - FEDERAL WAY, LLC in FEDERAL WAY. Also true for REDMOND CARE AND REHABILITATION CENTER in REDMOND.

## Data.Table > Take 1

My colleague who developed the allocation algorithm is on #TeamData.Table for zippy processing. To order data in a data.table we specify columns in  [setorder](https://www.rdocumentation.org/packages/data.table/versions/1.13.2/topics/setorder).

```{r datatable, warning=F, message=F}
library(data.table)
dt_data  <- fread(here("static", "data", "NFListing.csv"))
da_table <- dt_data[,.(city = nf_loc_city, name = nf_name)]
setorder(da_table, city, name)
da_table %>%
  kable()
```

***Observation:***: ALL CAPS city names precede Title Case city names per AVALON CARE CENTER - FEDERAL WAY, LLC in FEDERAL WAY. Things seem even weirder for REDMOND and RENTON where the 2 agencies with ALL CAPS cities precede the other 2 agencies in Redmond and Renton. 

## What to do? 

As a consultant, when discussing data quality, I would advocate for non-shouty data if source system flexibility makes that possible and doesn't impact prior data reporting. But sometimes when you are downstream from data, you may find yourself getting inconsistently formatted data and you have to make the decision on how much you care about maddening cases and determine if you even have the time to invest in attempting to format names, which is often a tricky business.

## #Tidyverse > Take 2

Rather than tackle agency names which may have initials and acronyms in ALL CAPS, formatting the city names will at least reveal where `dplyr::arrange` puts AVALON CARE CENTER - FEDERAL WAY, LLC once FEDERAL WAY is formatted. 

```{r tidyverseFormatCity, warning=F, message=F}
library(stringr)
data %>%
  mutate(city_formatted = str_to_title(city)) %>%
  arrange(city_formatted, name) %>%
  select(city, city_formatted, name) %>%
  head(40) %>%
  kable()
```

***Verdict:***: ***WINNER***

With my city data now formatted as Title Case, the secondary sorting of names is returned as hoped for both Federal Way, Redmond and Seattle agencies. 

## Data.Table > Take 2

```{r datatableFormatCity, warning=F, message=F}
# start over again with pre-ordered data.table
da_table <- dt_data[,.(city = nf_loc_city, name = nf_name)]
da_table[,city_formatted := str_to_title(city)]

setorder(da_table, city_formatted, name)
da_table[1:40,.(city, city_formatted, name)] %>%
  kable()
```

***Verdict:***: ***BETTER***

Secondary sort on mixed case names results in agency names starting with a given letter in ALL CAPS preceding other Title Cased names of same letter. 

## A Sorted Affair

As often is the case, thinking that a simple ordering of data is at most a 5 minute task, inconsistent data may quickly beckon one down a rabbit hole. An interesting, but also frustrating one. There is an inconsistency between `dplyr::arrange` and `data.table::setorder` when sorting by mixed case characters where the Tidyverse sorts Title Case data before ALL CAPS data and VICE VERSA for data.tables.